module.exports = {
    // parse an ODBC or ADO.NET connection string into
    parse: function (connectionString) {
        var properties = parseProperties(connectionString),
            server = parseServer(properties['server'] || properties['data source']);

        return {
            provider: 'sql',
            user: properties['user id'] || properties['uid'],
            password: properties['password'] || properties['pwd'],
            server: server,
            port: parsePort(properties['server'] || properties['data source']),
            database: properties['database'] || properties['initial catalog'],
            connectionTimeout: (parseInt(properties['connection timeout']) * 1000) || 15000,
            options: {
                // Azure requires encryption
                encrypt: server.indexOf('database.windows.net') > -1 || parseBoolean(properties['encrypt'])
            }
        };

        function parseServer(value) {
            var start = value.indexOf(':'),
                end = value.lastIndexOf(',');
            return value.substring(start + 1, end === -1 ? undefined : end);
        }

        function parsePort(value) {
            var start = value.lastIndexOf(',');
            return start === -1 ? undefined : parseInt(value.substring(start + 1));
        }

        function parseBoolean(value) {
            value = value && value.toLowerCase();
            return !!(value === 'true' || value === 'yes');
        }

        function parseProperties(source) {
            return source.split(';').reduce(function (properties, property) {
                var keyValue = property.split('='),
                    key = keyValue[0].toLowerCase(),
                    value = keyValue.length > 1 && keyValue[1];

                if(key)
                    properties[key] = value;

                return properties;
            }, {});
        }
    }
};
