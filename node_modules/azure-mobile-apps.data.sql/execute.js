var mssql = require('mssql'),
    promises = require('azure-mobile-apps.core/promises'),
    connection;

module.exports = function (config, statement) {
    // for some reason, creating a new connection object for each request hangs on the second request when hosted
    // not sure if this will have any effect on performance, i.e. does each request have to wait for the last to complete?
    if(!connection) {
        connection = new mssql.Connection(config)
        return connection.connect().then(executeRequest);
    } else
        return executeRequest();

    function executeRequest() {
        var request = new mssql.Request(connection);

        request.multiple = statement.multiple;

        statement.parameters && statement.parameters.forEach(function (parameter) {
            if(parameter.type)
                request.input(parameter.name, parameter.type, parameter.value);
            else
                request.input(parameter.name, parameter.value);
        });

        return request.query(statement.sql);
    }
};
