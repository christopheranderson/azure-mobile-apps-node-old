var helpers = require('../helpers'),
    _ = require('underscore.string');

module.exports = function (table, item, tableConfig) {
    tableConfig = tableConfig || {};
    var tableName = helpers.formatTableName(tableConfig.schema || 'dbo', table),
        self = this,
        columnNames = [],
        valueParams = [],
        parameters = [];

    Object.keys(item).forEach(function (prop) {
        // ignore the property if it is an autoIncrement id
        if (!(prop === 'id' && tableConfig.autoIncrement)) {
            columnNames.push(helpers.formatMember(prop));
            valueParams.push('@' + prop);
            parameters.push({ name: prop, value: item[prop] });
        }
    });

    var sql = _.sprintf("INSERT INTO %s (%s) VALUES (%s); ", tableName, columnNames.join(','), valueParams.join(','));

    if(tableConfig.autoIncrement)
        sql += _.sprintf('SELECT * FROM %s WHERE [id] = @@SCOPE_IDENTITY', tableName);
    else {
        sql += _.sprintf('SELECT * FROM %s WHERE [id] = @id', tableName);
    }

    return {
        sql: sql,
        parameters: parameters
    };
}
