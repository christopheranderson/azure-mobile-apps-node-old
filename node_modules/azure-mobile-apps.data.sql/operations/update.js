var helpers = require('../helpers'),
    _ = require('underscore.string');

module.exports = function (table, item, tableConfig) {
    tableConfig = tableConfig || {};
    var tableName = helpers.formatTableName(tableConfig.schema || 'dbo', table),
        setStatements = [],
        versionValue,
        parameters = [];

    for (var prop in item) {
        if(item.hasOwnProperty(prop)) {
            var value = item[prop];

            if (prop.toLowerCase() === '__version') {
                versionValue = value;
                continue;
            }

            if (prop.toLowerCase() == 'id') {
                continue;
            }

            setStatements.push(helpers.formatMember(prop) + ' = @' + prop);
            parameters.push({ name: prop, value: value });
        }
    }

    var sql = _.sprintf("UPDATE %s SET %s WHERE [id] = @id ", tableName, setStatements.join(','));
    parameters.push({ name: 'id', value: item.id });

    if (versionValue) {
        sql += "AND [__version] = @__version ";
        parameters.push({ name: '__version', value: versionValue })
    }

    sql += '; SELECT @@rowcount as __rowcount';
    sql += _.sprintf("; SELECT * FROM %s WHERE [id] = @id", tableName);

    return {
        sql: sql,
        parameters: parameters
    };
};
