var helpers = require('../helpers'),
    _ = require('underscore');

module.exports = function (table, item, tableConfig) {
    tableConfig = tableConfig || {};
    var tableName = helpers.formatTableName(tableConfig.schema || 'dbo', table),
        setStatements = [],
        versionValue,
        parameters = [];

    for (var prop in item) {
        if(item.hasOwnProperty(prop)) {
            var value = item[prop];

            if (prop.toLowerCase() === '__version') {
                versionValue = value;
                continue;
            }

            if (prop.toLowerCase() == 'id') {
                continue;
            }

            setStatements.push(helpers.formatMember(prop) + ' = ?');
            parameters.push(value);
        }
    }

    var sql = _.sprintf("UPDATE %s SET %s WHERE [id] = ? ", tableName, setStatements.join(','));
    parameters.push(item.id);

    if (versionValue) {
        sql += "AND [__version] = ? ";
        parameters.push(versionValue)
    }

    sql += '; SELECT @@rowcount as __rowcount';
    sql += _.sprintf("; SELECT * FROM %s WHERE [id] = ?", tableName);
    parameters.push(item.id);

    return {
        sql: sql,
        parameters: parameters
    };
};
