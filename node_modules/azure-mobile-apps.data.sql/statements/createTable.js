var helpers = require('../helpers');

module.exports = function (tableConfig, item) {
    var tableName = helpers.formatTableName(tableConfig.schema || 'dbo', tableConfig.name),

        pkName = 'PK_' + tableConfig.name,
        pkType = tableConfig.autoIncrement ? 'INT' : helpers.getSqlType((item.id === undefined || item.id === null) ? '' : item.id, true),
        pkColumnSql = '[id] ' + pkType + ' NOT NULL' + (tableConfig.autoIncrement ? ' IDENTITY (1, 1)' : ''),

        systemProperties = [
            pkColumnSql,
            //'__version rowversion NOT NULL',
            //'__createdAt datetime NOT NULL',
            //'__updatedAt datetime NOT NULL',
            //'__deleted bit NOT NULL'
        ]
        columnSql = systemProperties.concat(itemColumnsSql(item)).join(',');

    return {
        sql: 'CREATE TABLE ' + tableName + ' (' + columnSql + ') ON [PRIMARY]; ALTER TABLE ' + tableName + ' ADD CONSTRAINT ' + pkName + ' PRIMARY KEY CLUSTERED (id) ON [PRIMARY]'
    };
};

function itemColumnsSql(item) {
    return Object.keys(item).reduce(function (sql, property) {
        if(item[property] === null || item[property] === undefined)
            throw new Error('Unable to determine column type for table ' + tableConfig.name + ', property ' + property);

        if(property !== 'id')
            sql.push('[' + property + '] ' + helpers.getSqlType(item[property]) + ' NULL');

        return sql;
    }, []);
}
