var index = require('..'),
    execute = require('../execute'),
    queries = require('azure-mobile-apps.query'),
    expect = require('chai').expect;

describe('azure-mobile-apps.data.sql.integration.operations', function () {
    var config = {
            user: 'azure-mobile-apps-test',
            password: 'Blah1234',
            server: 'localhost',
            database: 'azure-mobile-apps-test'
        },
        operations = index(config);

    beforeEach(function (done) {
        return operations.truncate('integration').then(done);
    });

    it("basic connection test", function () {
        return execute(config, { sql: 'select * from integration', parameters: [] });
    });

    // we really need to add a purge method to make this less flaky
    it("basic integration test", function () {
        return insert({ id: 1, string: 'test', bool: false, number: 1 })
            .then(read)
            .then(function (results) {
                expect(results).to.deep.equal([{ id: 1, string: 'test', bool: false, number: 1 }]);
                return update({ id: 1, string: 'test2', bool: true, number: 2  });
            })
            .then(read)
            .then(function (results) {
                expect(results).to.deep.equal([{ id: 1, string: 'test2', bool: true, number: 2 }]);
                return del(1);
            })
            .then(read)
            .then(function (results) {
                expect(results.length).to.equal(0);
            });
    });

    it("preserves existing values if unspecified", function () {
        return insert({ id: 1, string: 'test', bool: true, number: 1 })
            .then(function () {
                return update({ id: 1, string: 'test2' });
            })
            .then(read)
            .then(function (results) {
                expect(results).to.deep.equal([{ id: 1, string: 'test2', bool: true, number: 1 }]);
                return del(1);
            });
    });

    function read() {
        return operations.read(queries.create('integration'));
    }

    function insert(item) {
        return operations.insert('integration', item);
    }

    function update(item) {
        return operations.update('integration', item);
    }

    function del(id) {
        return operations.delete('integration', id);
    }
});
