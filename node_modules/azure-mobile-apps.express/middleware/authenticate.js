var auth = require('azure-mobile-apps.auth'),
    log = require('azure-mobile-apps.core/logger');

module.exports = function (configuration) {
    return function (req, res, next) {
        var token = req.headers['x-zumo-auth'];

        if(token && configuration.auth) {
            auth.validate(configuration.auth, token)
                .then(function (claims) {
                    req.azureMobile = req.azureMobile || {};
                    req.azureMobile.user = claims;
                    next();
                })
                .catch(function (error) {
                    res.status(401).send(error);
                });
        } else {
            next();
        }
    };
};
