var loader = require('azure-mobile-apps.core/configuration/loader'),
    data = require('azure-mobile-apps.core/data'),
    configurationFactory = require('./configuration'),
    tableRouter = require('./tableRouter');

module.exports = function (configuration) {
    configuration.tables = configuration.tables || {};

    var router = tableRouter(),
        provider = data(configuration),
        middleware = function (req, res, next) {
            req.azureMobile = req.azureMobile || {};
            req.azureMobile.data = provider;
            req.azureMobile.req = req;
            req.azureMobile.res = res;

            router(req, res, next);
        };

    // allow configuration of a table by zumoInstance.tables.add('table')
    middleware.add = function (name, definition) {
        if(!definition || !definition.createMiddleware)
            definition = configurationFactory(definition);
        configuration.tables[name] = definition;
        router.add(name, definition);
    };

    // allow configuration of tables by zumoInstance.tables.import('path/to/config')
    middleware.import = function (path) {
        var tables = loader.loadPath(path, configuration.basePath);
        Object.keys(tables).forEach(function (tableName) {
            var definition = tables[tableName];

            // the default module.exports (i.e. empty file) is an empty object
            // we need to convert this back to undefined for middleware.add
            if(definition && Object.keys(definition).length === 0)
                definition = undefined;

            middleware.add(tableName, definition);
        });
    };

    // expose configuration through zumoInstance.tables.configuration
    middleware.configuration = configuration.tables;

    middleware.stack = router.stack;

    return middleware;
}
