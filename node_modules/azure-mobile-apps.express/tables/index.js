var loader = require('azure-mobile-apps.core/configuration/loader'),
    configurationFactory = require('./configurationFactory'),
    tableRouter = require('./tableRouter');

module.exports = function (configuration) {
    configuration.tables = configuration.tables || {};
    
    var router = tableRouter(),
        // we don't want to attach methods to the actual router in case we clobber something
        // create new middleware that delegates to the router, attach stuff and return that instead
        // returning this middleware allows people to attach middleware by app.use(zumoInstance.tables)
        middleware = function (req, res, next) { 
            router(req, res, next);
        };
    
    // allow configuration of a table by zumoInstance.tables.add('table')
    middleware.add = function (name, definition) {
        definition = definition || configurationFactory();
        configuration.tables[name] = definition;
        router.add(name, definition);
    };
    
    // allow configuration of tables by zumoInstance.tables.import('path/to/config')
    middleware.import = function (path) {
        var tables = loader.loadPath(path, configuration.basePath);
        Object.keys(tables).forEach(function (tableName) {
            middleware.add(tableName, tables[tableName]);
        });
    };
    
    middleware.stack = router.stack;
    
    // expose configuration through zumoInstance.tables.configuration
    middleware.configuration = configuration.tables;

    return middleware;
}
