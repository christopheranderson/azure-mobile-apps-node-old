var expect = require('chai').use(require('chai-subset')).expect,
    request = require('supertest-as-promised'),
    config = require('../infrastructure/config')(),
    express = require('express'),
    mobileApps = require('azure-mobile-apps.express'),
    data = require('azure-mobile-apps.data.sql'),
    queries = require('azure-mobile-apps.query'),
    app, mobileApp;

describe('azure-mobile-apps.express.integration.api', function () {
    beforeEach(function () {
        app = express();
        mobileApp = mobileApps({ data: config });
    });

    afterEach(function (done) {
        data(config).execute({ sql: 'drop table apiTest' }).then(done, function () { done(); });
    });

    it('exposes table access through request object', function () {
        mobileApp.tables.add('apiTest', { dynamicSchema: false });
        mobileApp.attach(app);

        app.get('/api/test', function (req, res, next) {
            expect(req.azureMobile.tables.apiTest.name).to.equal('apiTest');
            expect(req.azureMobile.tables.apiTest.dynamicSchema).to.be.false;
            res.status(200).end();
        });

        return request(app)
            .get('/api/test')
            .expect(200);
    });

    it('exposes data access object through request object', function () {
        mobileApp.tables.add('apiTest');
        mobileApp.attach(app);

        app.get('/api/test', function (req, res, next) {
            expect(req.azureMobile.table('apiTest').read).to.be.a('function');
            res.status(200).end();
        });

        return request(app)
            .get('/api/test')
            .expect(200);
    });

    it('allows table operations', function () {
        mobileApp.tables.add('apiTest');
        mobileApp.attach(app);

        app.get('/api/createTest', function (req, res, next) {
            req.azureMobile.table('apiTest').insert({ id: '1', value: 'test1' }).then(function () {
                res.status(200).end();
            });
        });

        app.get('/api/getTest', function (req, res, next) {
            var query = queries.create('apiTest').where({ id: '1' });
            req.azureMobile.table('apiTest').read(query).then(function (results) {
                res.status(200).json(results);
            });
        });

        return request(app)
            .get('/api/createTest')
            .expect(200)
            .then(function () {
                return request(app)
                    .get('/api/getTest')
                    .expect(200);
            })
            .then(function (res) {
                expect(res.body).to.containSubset([{ id: '1', value: 'test1' }]);
            });
    });
});
