var expect = require('chai').expect,
    supertest = require('supertest-as-promised'),
    express = require('express'),
    mobileApps = require('azure-mobile-apps.express'),
    data = require('azure-mobile-apps.data.sql'),
    config = require('../infrastructure/config'),

    app, mobileApp;

describe('azure-mobile-apps.express.integration.tables.data', function () {
    beforeEach(function (done) {
        app = express();
        mobileApp = mobileApps({ data: config });
        data(config)({ name: 'integration' }).truncate().then(done);
    });

    it('returns inserted records', function () {
        mobileApp.tables.add('integration');
        mobileApp.attach(app);

        return supertest(app)
            .post('/tables/integration')
            .send({ id: '1', string: "test", bool: true, number: 1 })
            .expect(200)
            .then(function (res) {
                return supertest(app)
                    .get('/tables/integration')
                    .expect(200);
            })
            .then(function (res) {
                expect(res.body).to.deep.equal([{ id: '1', string: "test", bool: true, number: 1 }]);
            });
    });

    it('returns updated records', function () {
        mobileApp.tables.add('integration');
        mobileApp.attach(app);

        return supertest(app)
            .post('/tables/integration')
            .send({ id: '1', string: "test" })
            .then(function (res) {
                return supertest(app)
                    .patch('/tables/integration')
                    .send({ id: 1, string: "test2", bool: true, number: 1 })
            })
            .then(function (res) {
                return supertest(app).get('/tables/integration');
            })
            .then(function (res) {
                expect(res.body).to.deep.equal([{ id: '1', string: "test2", bool: true, number: 1 }]);
            });
    });

    it('does not return deleted records', function () {
        mobileApp.tables.add('integration');
        mobileApp.attach(app);

        return supertest(app)
            .post('/tables/integration')
            .send({ id: '1', string: "test" })
            .expect(200)
            .then(function (res) {
                return supertest(app)
                    .delete('/tables/integration/1')
                    .expect(200);
            })
            .then(function (res) {
                return supertest(app).get('/tables/integration');
            })
            .then(function (res) {
                expect(res.body).to.deep.equal([]);
            });
    });

    it('returns empty array when table with dynamic schema has not been created', function () {
        mobileApp.tables.add('nonexistent');
        mobileApp.attach(app);

        return supertest(app)
            .get('/tables/nonexistent')
            .expect(200)
            .then(function (res) {
                expect(res.body).to.deep.equal([]);
            });
    });

    it('returns empty array when table with dynamic schema has not been updated', function () {
        mobileApp.tables.add('integration');
        mobileApp.attach(app);

        return supertest(app)
            .post('/tables/integration')
            .send({ id: '1', string: "test" })
            .then(function (res) {
                return supertest(app)
                    .get('/tables/integration?$filter=newCol eq 1')
                    .expect(200);
            })
            .then(function (res) {
                expect(res.body).to.deep.equal([]);
            });
    });

    it('assigns guid id if none is provided and table does not have an autoIncrement id', function () {
        mobileApp.tables.add('integration');
        mobileApp.attach(app);

        return supertest(app)
            .post('/tables/integration')
            .send({ string: "test", bool: true, number: 1 })
            .expect(200)
            .then(function (res) {
                return supertest(app)
                    .get('/tables/integration')
                    .expect(200);
            })
            .then(function (res) {
                expect(res.body.length).to.equal(1);
                expect(res.body[0].id).to.not.be.undefined;
            });
    });
});
