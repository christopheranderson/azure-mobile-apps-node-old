var expect = require('chai').expect,
    supertest = require('supertest-as-promised'),
    express = require('express'),
    mobileApps = require('azure-mobile-apps.express'),
    data = require('azure-mobile-apps.data.sql'),

    app, mobileApp;

describe('azure-mobile-apps.express.integration.tables.data', function () {
    var config = {
        provider: 'sql',
        user: 'azure-mobile-apps-test',
        password: 'Blah1234',
        server: 'localhost',
        database: 'azure-mobile-apps-test'
    };

    beforeEach(function () {
        app = express();
        mobileApp = mobileApps({ data: config });
    });

    afterEach(function (done) {
        data(config).execute({ sql: 'drop table dynamic' }).then(done, done);
    });

    it('creates table and returns inserted records', function () {
        mobileApp.tables.add('dynamic');
        mobileApp.attach(app);

        return supertest(app)
            .post('/tables/dynamic')
            .send({ id: '1', string: "test", bool: true, number: 1 })
            .expect(200)
            .then(function (res) {
                return supertest(app)
                    .get('/tables/dynamic')
                    .expect(200);
            })
            .then(function (res) {
                expect(res.body).to.deep.equal([{ id: '1', string: "test", bool: true, number: 1 }]);
            });
    });
});
