var core = require('azure-mobile-apps.core'),
    path = require('path'),

    platforms = {
        express: require('azure-mobile-apps.express'),
    },

    defaults = {
        platform: 'express',
        basePath: path.dirname(module.parent.filename),
        configFile: 'azureMobile',
        promiseConstructor: Promise,
        tableRootPath: '/tables',
        data: { }
    };

module.exports = function (configuration) {
    configuration = configuration || {};
    var configFile = path.resolve(configuration.basePath || defaults.basePath, configuration.configFile || defaults.configFile);
    configuration = core.utilities.assign(core.configuration.fromFile(configFile), defaults, configuration);
    core.configuration.fromEnvironment(configuration);
    core.logger.initialise(configuration.logging);

    return platforms[configuration.platform](configuration);
};
