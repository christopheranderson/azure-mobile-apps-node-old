var logger = require('azure-mobile-apps.core/logger'),
    path = require('path'),
    utilities = require('azure-mobile-apps.core/utilities'),
    platforms = {
        express: require('azure-mobile-apps.express'),
    },
    defaults = {
        basePath: path.dirname(module.parent.filename),
        debug: debugMode(),
        promiseConstructor: Promise,
        tableRootPath: '/tables',
        data: { }
    };

module.exports = function (configuration) {
    configuration = utilities.assign({}, defaults, configuration);
    logger.initialise(configuration.logging);

    // by default, return the express middleware implementation
    return platforms[configuration.platform || 'express'](configuration);
};

function debugMode() {
    return process.execArgv.some(function (arg) {
        return arg.indexOf('--debug') === 0;
    });
}
